'use client';

import React, { useEffect, useState } from 'react';
import Link from 'next/link';
import { useParams, useRouter } from 'next/navigation';
import Card from '@/components/Card';
import ScoreGauge from '@/components/ScoreGauge';
import LoanRow from '@/components/LoanRow';
import AlertBanner from '@/components/AlertBanner';
import CallbackSelector from '@/components/CallbackSelector';
import PrimaryButton from '@/components/PrimaryButton';
import { getHealthCheck, submitCallback, type HealthCheckResponse } from '@/lib/api';
import { analytics } from '@/lib/analytics';

function formatCurrency(amount: number): string {
    return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        maximumFractionDigits: 0,
    }).format(amount);
}

export default function ResultsPage() {
    const params = useParams();
    const router = useRouter();
    const id = params.id as string;

    const [data, setData] = useState<HealthCheckResponse | null>(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState('');
    const [callbackLoading, setCallbackLoading] = useState(false);
    const [callbackDone, setCallbackDone] = useState(false);

    useEffect(() => {
        if (id) {
            getHealthCheck(id)
                .then(setData)
                .catch((err) => setError(err.message))
                .finally(() => setLoading(false));
        }
    }, [id]);

    const handleCallback = async (dateTime: string) => {
        if (!data) return;
        setCallbackLoading(true);
        try {
            await submitCallback(data.id, dateTime);
            analytics.callbackSubmitted();
            setCallbackDone(true);
            router.push('/callback-confirmed');
        } catch (err: unknown) {
            setError(err instanceof Error ? err.message : 'Failed to schedule callback.');
        } finally {
            setCallbackLoading(false);
        }
    };

    const handleDownloadPDF = () => {
        analytics.pdfDownloaded();
        if (!data) return;
        const content = `
EXITDEBT ‚Äî DEBT HEALTH REPORT
================================
Debt Health Score: ${data.score}/100 (${data.category})
Credit Score: ${data.credit_score || 'N/A'}

SUMMARY
-------
Total Outstanding: ${formatCurrency(data.total_outstanding)}
Total EMI: ${formatCurrency(data.total_emi)}/month
Average Interest Rate: ${data.avg_rate}%
Potential Annual Savings: ${formatCurrency(data.savings_est)}

DEBT ACCOUNTS
-------------
${data.debt_accounts.map((a) => `${a.lender_name} | ${a.account_type} | ${formatCurrency(a.outstanding)} | ${a.interest_rate}% | ${a.status}`).join('\n')}

${data.flagged_accounts.length > 0 ? `\nFLAGGED ACCOUNTS\n${data.flagged_accounts.map((f) => `‚ö† ${f.lender_name}: ${f.reason}`).join('\n')}` : ''}

Report generated by ExitDebt (https://exitdebt.in)
    `.trim();

        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `exitdebt-report-${data.score}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    };

    const handleWhatsAppShare = () => {
        analytics.whatsappShared();
        if (data?.whatsapp_share_link) {
            window.open(data.whatsapp_share_link, '_blank');
        }
    };

    if (loading) {
        return (
            <main className="min-h-screen flex items-center justify-center">
                <div className="text-center">
                    <div className="w-12 h-12 border-3 border-border border-t-purple rounded-full animate-spin mx-auto mb-4" />
                    <p className="text-text-secondary">Finding where your money is going...</p>
                </div>
            </main>
        );
    }

    if (error || !data) {
        return (
            <main className="min-h-screen flex items-center justify-center px-4">
                <Card className="max-w-md w-full text-center p-8">
                    <h2 className="text-xl font-bold text-text-primary mb-2">Unable to Load Results</h2>
                    <p className="text-text-secondary mb-6">{error || 'Health check not found.'}</p>
                    <PrimaryButton onClick={() => router.push('/')}>Try Again</PrimaryButton>
                </Card>
            </main>
        );
    }

    return (
        <main className="min-h-screen py-8 px-4">
            <div className="max-w-4xl mx-auto">
                {/* Header */}
                <div className="flex items-center justify-between mb-8">
                    <Link href="/" className="text-xl font-bold">
                        <span className="text-text-primary">Exit</span>
                        <span className="gradient-text">Debt</span>
                    </Link>
                    <div className="flex gap-2">
                        <PrimaryButton variant="ghost" size="sm" onClick={handleDownloadPDF}>
                            üìÑ Download
                        </PrimaryButton>
                        <PrimaryButton variant="ghost" size="sm" onClick={handleWhatsAppShare}>
                            üí¨ Share
                        </PrimaryButton>
                    </div>
                </div>

                {/* Score Section */}
                <Card className="text-center p-8 mb-6 animate-fade-in-up">
                    <h1 className="text-xl font-bold text-text-primary mb-6">Here&apos;s What Your Debt Is Really Costing You</h1>
                    <ScoreGauge score={data.score} category={data.category} />
                    {data.credit_score && (
                        <p className="mt-4 text-sm text-text-secondary">
                            CIBIL Score: <span className="text-text-primary font-semibold">{data.credit_score}</span>
                        </p>
                    )}
                </Card>

                {/* Summary Cards */}
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                    {[
                        { label: 'You Owe', value: formatCurrency(data.total_outstanding), color: 'text-text-primary' },
                        { label: 'You Pay Every Month', value: formatCurrency(data.total_emi), color: 'text-text-primary' },
                        { label: 'Your Interest Rate', value: `${data.avg_rate.toFixed(1)}%`, color: data.avg_rate > 20 ? 'text-danger' : 'text-blue' },
                        { label: "You're Overpaying Per Year", value: formatCurrency(data.savings_est), color: 'text-danger' },
                    ].map((item, i) => (
                        <Card key={i} padding="sm" className="animate-fade-in-up" style={{ animationDelay: `${i * 0.1}s` }}>
                            <p className="text-xs text-text-muted mb-1">{item.label}</p>
                            <p className={`text-lg font-bold ${item.color}`}>{item.value}</p>
                        </Card>
                    ))}
                </div>

                {/* Consequence Framing */}
                {data.savings_est > 0 && (
                    <Card className="p-6 mb-6 animate-fade-in-up animate-delay-1">
                        <p className="text-base font-semibold text-text-primary mb-3">
                            You&apos;re overpaying {formatCurrency(data.savings_est)} every year.
                        </p>
                        <div className="flex flex-wrap gap-3">
                            {[
                                { emoji: '‚úàÔ∏è', text: `That's ${Math.floor(data.savings_est / 40000)} family vacation${Math.floor(data.savings_est / 40000) !== 1 ? 's' : ''}.` },
                                { emoji: 'üì±', text: `That's ${Math.floor(data.savings_est / (data.total_emi || 1))} EMI${Math.floor(data.savings_est / (data.total_emi || 1)) !== 1 ? 's' : ''} you don't need to pay.` },
                                { emoji: 'üõí', text: `That's ${Math.floor(data.savings_est / 8000)} months of groceries.` },
                            ].filter(item => {
                                const num = parseInt(item.text.match(/\d+/)?.[0] || '0');
                                return num >= 1;
                            }).map((item, i) => (
                                <span key={i} className="text-sm text-text-secondary bg-bg-soft px-3 py-1.5 rounded-lg">
                                    {item.emoji} {item.text}
                                </span>
                            ))}
                        </div>
                    </Card>
                )}

                {/* Flagged Accounts */}
                {data.flagged_accounts.length > 0 && (
                    <div className="mb-6 space-y-3 animate-fade-in-up animate-delay-2">
                        <h2 className="text-lg font-semibold text-text-primary">‚ö†Ô∏è These Accounts Are Costing You the Most</h2>
                        {data.flagged_accounts.map((f, i) => (
                            <AlertBanner
                                key={i}
                                type="warning"
                                message={`${f.lender_name} (${f.account_type}): ${f.reason} ‚Äî Outstanding: ${formatCurrency(f.outstanding)}`}
                            />
                        ))}
                    </div>
                )}

                {/* Debt Accounts */}
                <div className="mb-8 animate-fade-in-up animate-delay-3">
                    <h2 className="text-lg font-semibold text-text-primary mb-4">Your Debt Breakdown</h2>
                    <div className="space-y-3">
                        {data.debt_accounts.map((account) => (
                            <LoanRow
                                key={account.id}
                                lenderName={account.lender_name}
                                accountType={account.account_type}
                                outstanding={account.outstanding}
                                interestRate={account.interest_rate}
                                emiAmount={account.emi_amount}
                                status={account.status}
                            />
                        ))}
                    </div>
                </div>

                {/* Callback Section */}
                {!callbackDone && (
                    <Card className="mb-8 animate-fade-in-up animate-delay-4">
                        <CallbackSelector onSubmit={handleCallback} loading={callbackLoading} />
                    </Card>
                )}

                {/* Timeline Urgency */}
                <Card className="p-6 mb-6 text-center animate-fade-in-up">
                    <p className="text-sm text-text-secondary">
                        If you act this week, your EMIs could drop within <span className="font-semibold text-text-primary">14‚Äì21 days</span>.
                    </p>
                </Card>

                {/* Advisory CTA */}
                <Card className="text-center p-8 mb-8">
                    <h2 className="text-xl font-bold text-text-primary mb-2">Here&apos;s What Happens Next</h2>
                    <p className="text-text-secondary mb-6">
                        Our team will build a clear plan to reduce your EMIs. No jargon, no pressure.
                    </p>
                    <div className="flex flex-col sm:flex-row gap-4 justify-center">
                        {[
                            { tier: 'Basic', price: '‚Çπ499', desc: 'Clear report + action plan' },
                            { tier: 'Standard', price: '‚Çπ1,499', desc: '+ 1-on-1 call with advisor' },
                            { tier: 'Premium', price: '‚Çπ2,999', desc: '+ We negotiate with your lenders' },
                        ].map((plan) => (
                            <div
                                key={plan.tier}
                                className="glass-card p-4 flex-1 hover:border-purple/30 transition-colors cursor-pointer"
                            >
                                <p className="font-semibold text-text-primary">{plan.tier}</p>
                                <p className="text-2xl font-bold gradient-text my-1">{plan.price}</p>
                                <p className="text-xs text-text-secondary">{plan.desc}</p>
                            </div>
                        ))}
                    </div>
                </Card>

                {/* Footer */}
                <div className="text-center text-xs text-text-muted py-8">
                    <p>Data encrypted with AES-256 ‚Ä¢ Auto-deleted after 30 days ‚Ä¢ <a href="/privacy" className="text-purple hover:underline">Privacy Policy</a></p>
                </div>
            </div>
        </main>
    );
}
